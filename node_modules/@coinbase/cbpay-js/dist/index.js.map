{"version":3,"sources":["../src/config.ts","../src/onramp/generateOnRampURL.ts","../src/utils/createEmbeddedContent.ts","../src/utils/postMessage.ts","../src/offramp/generateOffRampURL.ts","../src/utils/CoinbasePixel.ts","../src/utils/CBPayInstance.ts","../src/onramp/initOnRamp.ts","../src/utils/events.ts"],"names":["DEFAULT_HOST","generateOnRampURL","host","props","url","URL","pathname","destinationWallets","addresses","Error","Object","keys","forEach","key","value","undefined","includes","searchParams","append","toString","JSON","stringify","sort","EMBEDDED_IFRAME_ID","createEmbeddedContent","width","height","position","top","iframe","document","createElement","style","border","borderWidth","id","src","MessageCodes","onBroadcastedPostMessage","messageCode","onMessage","callback","shouldUnsubscribe","allowedOrigin","onValidateOrigin","Promise","resolve","e","eventName","data","parsePostMessage","isOriginAllowed","origin","window","removeEventListener","addEventListener","getSdkTarget","win","isMobileSdkTarget","postMessage","message","ReactNativeWebView","opener","parent","self","broadcastPostMessage","formatPostMessage","parse","generateOffRampURL","PopupSizes","signin","widget","CoinbasePixel","constructor","appId","appParams","debug","theme","eventStreamListeners","unsubs","openExperience","options","log","setupExperienceListeners","experienceLoggedIn","experienceLoggedOut","embeddedContentStyles","experience","path","openEmbeddedExperience","embedded","target","querySelector","replaceChildren","body","appendChild","startDirectSignin","chrome","windows","create","setSelfAsOpener","type","focused","left","screenLeft","screenTop","winRef","onOpenCallback","update","removeEventStreamListener","addEventStreamListener","tabs","openWindow","endExperience","getElementById","remove","destroy","unsub","onSuccess","onExit","onEvent","onRequestedUrl","metadata","cb","error","queryParams","URLSearchParams","set","directSigninUrl","signinWinRef","close","name","push","filteredListeners","filter","args","unsubFxn","console","open","widgetRoutes","buy","checkout","sell","CBPayInstance","pixel","closeOnSuccess","closeOnExit","targetElement","initOnRamp","widgetParameters","instance","broadcastEvent","sdkTarget","event"],"mappings":"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","sourcesContent":["export const DEFAULT_HOST = 'https://pay.coinbase.com';\n","import { DEFAULT_HOST } from '../config';\nimport { OnRampAppParams } from '../types/onramp';\nimport type { Theme } from '../types/widget';\n\nexport type GenerateOnRampURLOptions = {\n  /** This & destinationWallets or sessionToken are required. */\n  appId?: string;\n  host?: string;\n  /** This or appId & destinationWallets are required. */\n  sessionToken?: string;\n  theme?: Theme;\n} & OnRampAppParams;\n\nexport const generateOnRampURL = ({\n  host = DEFAULT_HOST,\n  ...props\n}: GenerateOnRampURLOptions): string => {\n  const url = new URL(host);\n  url.pathname = '/buy/select-asset';\n\n  if (props.destinationWallets && props.addresses) {\n    throw new Error('Only one of destinationWallets or addresses can be provided');\n  } else if (!props.destinationWallets && !props.addresses) {\n    throw new Error('One of destinationWallets or addresses must be provided');\n  }\n\n  (Object.keys(props) as (keyof typeof props)[]).forEach((key) => {\n    const value = props[key];\n    if (value !== undefined) {\n      if (['string', 'number', 'boolean'].includes(typeof value)) {\n        url.searchParams.append(key, value.toString());\n      } else {\n        url.searchParams.append(key, JSON.stringify(value));\n      }\n    }\n  });\n\n  url.searchParams.sort();\n\n  return url.toString();\n};\n","import { EmbeddedContentStyles } from 'types/widget';\n\nexport const EMBEDDED_IFRAME_ID = 'cbpay-embedded-onramp';\n\nexport const createEmbeddedContent = ({\n  url,\n  width = '100%',\n  height = '100%',\n  position = 'fixed',\n  top = '0px',\n}: {\n  url: string;\n} & EmbeddedContentStyles): HTMLIFrameElement => {\n  const iframe = document.createElement('iframe');\n\n  // Styles\n  iframe.style.border = 'unset';\n  iframe.style.borderWidth = '0';\n  iframe.style.width = width.toString();\n  iframe.style.height = height.toString();\n  iframe.style.position = position;\n  iframe.style.top = top;\n  iframe.id = EMBEDDED_IFRAME_ID;\n  iframe.src = url;\n\n  return iframe;\n};\n","import { JsonObject } from '../types/JsonTypes';\n\nexport enum MessageCodes {\n  LaunchEmbedded = 'launch_embedded',\n  AppReady = 'app_ready',\n  AppParams = 'app_params',\n  SigninSuccess = 'signin_success',\n  Success = 'success', // TODO: deprecate\n  Exit = 'exit', // TODO: deprecate\n  Event = 'event',\n  Error = 'error',\n\n  PixelReady = 'pixel_ready',\n  OnAppParamsNonce = 'on_app_params_nonce',\n}\n\nexport type MessageCode = `${MessageCodes}`;\n\nexport type MessageData = JsonObject;\n\nexport type PostMessageData = {\n  eventName: MessageCode;\n  data?: MessageData;\n};\n\nexport const onBroadcastedPostMessage = (\n  messageCode: MessageCode,\n  {\n    onMessage: callback,\n    shouldUnsubscribe = true,\n    allowedOrigin,\n    onValidateOrigin = () => Promise.resolve(true),\n  }: {\n    onMessage: (data?: MessageData) => void;\n    shouldUnsubscribe?: boolean;\n    allowedOrigin?: string;\n    onValidateOrigin?: (origin: string) => Promise<boolean>;\n  },\n): (() => void) => {\n  const onMessage = (e: MessageEvent) => {\n    const { eventName, data } = parsePostMessage(e.data as string);\n    const isOriginAllowed = !allowedOrigin || e.origin === allowedOrigin;\n\n    if (eventName === messageCode) {\n      void (async () => {\n        if (isOriginAllowed && (await onValidateOrigin(e.origin))) {\n          callback(data);\n          if (shouldUnsubscribe) {\n            window.removeEventListener('message', onMessage);\n          }\n        }\n      })();\n    }\n  };\n\n  window.addEventListener('message', onMessage);\n\n  // Unsubscribe\n  return () => {\n    window.removeEventListener('message', onMessage);\n  };\n};\n\nexport type SdkTarget = Window | { postMessage: typeof window.postMessage };\n\nexport const getSdkTarget = (win: Window): SdkTarget | undefined => {\n  if (win !== window) {\n    // Internal to SDK\n    return win;\n  } else if (isMobileSdkTarget(win)) {\n    // Mobile SDK\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    return { postMessage: (message: string) => win.ReactNativeWebView!.postMessage!(message) };\n  } else if (win.opener) {\n    // Button proxy\n    return win.opener;\n  } else if (win.parent !== win.self) {\n    // Third party / SDK\n    return win.parent;\n  } else {\n    return undefined;\n  }\n};\n\nconst isMobileSdkTarget = (win: Window) => {\n  try {\n    return win.ReactNativeWebView?.postMessage !== undefined;\n  } catch {\n    return false;\n  }\n};\n\nexport const broadcastPostMessage = (\n  win: SdkTarget,\n  eventName: MessageCode,\n  { allowedOrigin = '*', data }: { allowedOrigin?: string; data?: MessageData } = {},\n): void => {\n  const message = formatPostMessage(eventName, data);\n  win.postMessage(message, allowedOrigin);\n};\n\nconst parsePostMessage = (data: string): PostMessageData => {\n  try {\n    return JSON.parse(data) as PostMessageData;\n  } catch {\n    return { eventName: data as MessageCode }; // event name only\n  }\n};\n\nconst formatPostMessage = (\n  eventName: PostMessageData['eventName'],\n  data?: PostMessageData['data'],\n): string => {\n  if (data) {\n    return JSON.stringify({ eventName, data });\n  }\n  return eventName;\n};\n","import { OffRampAppParams } from 'types/offramp';\nimport { DEFAULT_HOST } from '../config';\nimport type { Theme } from '../types/widget';\n\nexport type GenerateOffRampURLOptions = {\n  /** This & addresses or sessionToken are required. */\n  appId?: string;\n  host?: string;\n  theme?: Theme;\n  /** This or appId & addresses are required. */\n  sessionToken?: string;\n} & OffRampAppParams;\n\nexport const generateOffRampURL = ({\n  host = DEFAULT_HOST,\n  ...props\n}: GenerateOffRampURLOptions): string => {\n  const url = new URL(host);\n  url.pathname = '/v3/sell/input';\n\n  (Object.keys(props) as (keyof typeof props)[]).forEach((key) => {\n    const value = props[key];\n    if (value !== undefined) {\n      if (['string', 'number', 'boolean'].includes(typeof value)) {\n        url.searchParams.append(key, value.toString());\n      } else {\n        url.searchParams.append(key, JSON.stringify(value));\n      }\n    }\n  });\n\n  url.searchParams.sort();\n\n  return url.toString();\n};\n","import { DEFAULT_HOST } from '../config';\nimport { EmbeddedContentStyles, Experience, Theme } from 'types/widget';\nimport { createEmbeddedContent, EMBEDDED_IFRAME_ID } from './createEmbeddedContent';\nimport { JsonObject } from 'types/JsonTypes';\nimport { onBroadcastedPostMessage } from './postMessage';\nimport { EventMetadata } from 'types/events';\nimport { generateOnRampURL } from '../onramp/generateOnRampURL';\nimport { generateOffRampURL } from '../offramp/generateOffRampURL';\n\nconst PopupSizes: Record<'signin' | 'widget', { width: number; height: number }> = {\n  signin: {\n    width: 460,\n    height: 730,\n  },\n  widget: {\n    width: 430,\n    height: 600,\n  },\n};\n\nexport type ExperienceListeners = {\n  onExit?: (data?: JsonObject) => void;\n  onSuccess?: (data?: JsonObject) => void;\n  onEvent?: (event: EventMetadata) => void;\n  onRequestedUrl?: (url: string) => void;\n};\n\nexport type CoinbasePixelConstructorParams = {\n  host?: string;\n  appId: string;\n  appParams: JsonObject;\n  debug?: boolean;\n  theme?: Theme;\n};\n\nexport type OpenExperienceOptions = {\n  path: string;\n  experienceLoggedIn: Experience;\n  experienceLoggedOut?: Experience;\n  embeddedContentStyles?: EmbeddedContentStyles;\n} & ExperienceListeners;\n\nexport class CoinbasePixel {\n  private debug: boolean;\n  private host: string;\n  private appId: string;\n  private eventStreamListeners: Partial<Record<EventMetadata['eventName'], (() => void)[]>> = {};\n  private unsubs: (() => void)[] = [];\n  private appParams: JsonObject;\n  private removeEventListener?: () => void;\n  private theme: Theme | null | undefined;\n\n  constructor({\n    host = DEFAULT_HOST,\n    appId,\n    appParams,\n    debug,\n    theme,\n  }: CoinbasePixelConstructorParams) {\n    this.host = host;\n    this.appId = appId;\n    this.appParams = appParams;\n    this.debug = debug || false;\n    this.theme = theme;\n  }\n\n  /** Opens the CB Pay experience */\n  public openExperience = (options: OpenExperienceOptions): void => {\n    this.log('Attempting to open experience');\n\n    this.setupExperienceListeners(options);\n\n    const { experienceLoggedIn, experienceLoggedOut, embeddedContentStyles } = options;\n\n    const experience = experienceLoggedOut || experienceLoggedIn;\n\n    let url = '';\n    if (options.path === '/v3/sell') {\n      url = generateOffRampURL({\n        appId: this.appId,\n        host: this.host,\n        theme: this.theme ?? undefined,\n        ...this.appParams,\n      });\n    } else {\n      url = generateOnRampURL({\n        appId: this.appId,\n        host: this.host,\n        theme: this.theme ?? undefined,\n        ...this.appParams,\n      });\n    }\n\n    this.log('Opening experience', { experience });\n\n    if (experience === 'embedded') {\n      this.log(\n        'DEPRECATION WARNING: Two factor authentication does not work in an iframe, so the embedded experience should not be used. It will be removed in a future release',\n      );\n      const openEmbeddedExperience = () => {\n        const embedded = createEmbeddedContent({ url, ...embeddedContentStyles });\n        if (embeddedContentStyles?.target) {\n          document.querySelector(embeddedContentStyles?.target)?.replaceChildren(embedded);\n        } else {\n          document.body.appendChild(embedded);\n        }\n      };\n\n      this.startDirectSignin(openEmbeddedExperience);\n    } else if (experience === 'popup' && window.chrome?.windows?.create) {\n      void window.chrome.windows.create(\n        {\n          url,\n          setSelfAsOpener: true,\n          type: 'popup',\n          focused: true,\n          width: PopupSizes.signin.width,\n          height: PopupSizes.signin.height,\n          left: window.screenLeft - PopupSizes.signin.width - 10,\n          top: window.screenTop,\n        },\n        (winRef) => {\n          const onOpenCallback = () => {\n            if (winRef?.id) {\n              chrome.windows.update(winRef.id, {\n                width: PopupSizes.widget.width,\n                height: PopupSizes.widget.height,\n                left: window.screenLeft - PopupSizes.widget.width - 10,\n                top: window.screenTop,\n              });\n              this.removeEventStreamListener('open', onOpenCallback);\n            }\n          };\n          this.addEventStreamListener('open', onOpenCallback);\n        },\n      );\n    } else if (experience === 'new_tab' && window.chrome?.tabs?.create) {\n      void window.chrome.tabs.create({ url });\n    } else {\n      openWindow(url, experience);\n    }\n  };\n\n  public endExperience = (): void => {\n    document.getElementById(EMBEDDED_IFRAME_ID)?.remove();\n  };\n\n  public destroy = (): void => {\n    this.unsubs.forEach((unsub) => unsub());\n  };\n\n  private setupExperienceListeners = ({\n    onSuccess,\n    onExit,\n    onEvent,\n    onRequestedUrl,\n  }: ExperienceListeners) => {\n    // Unsubscribe from events in case there's still an active listener\n    if (this.removeEventListener) {\n      this.removeEventListener();\n    }\n\n    this.removeEventListener = this.onMessage('event', {\n      shouldUnsubscribe: false,\n      onMessage: (data) => {\n        const metadata = data as EventMetadata;\n\n        this.eventStreamListeners[metadata.eventName]?.forEach((cb) => cb?.());\n\n        if (metadata.eventName === 'success') {\n          onSuccess?.();\n        }\n        if (metadata.eventName === 'exit') {\n          onExit?.(metadata.error);\n        }\n        if (metadata.eventName === 'request_open_url') {\n          onRequestedUrl?.(metadata.url);\n        }\n        onEvent?.(data as EventMetadata);\n      },\n    });\n  };\n\n  private startDirectSignin = (callback: () => void) => {\n    const queryParams = new URLSearchParams();\n    queryParams.set('appId', this.appId);\n    queryParams.set('type', 'direct');\n    const directSigninUrl = `${this.host}/signin?${queryParams.toString()}`;\n    const signinWinRef = openWindow(directSigninUrl, 'popup');\n\n    this.onMessage('signin_success', {\n      onMessage: () => {\n        signinWinRef?.close();\n        callback();\n      },\n    });\n  };\n\n  private addEventStreamListener = (name: EventMetadata['eventName'], cb: () => void) => {\n    if (this.eventStreamListeners[name]) {\n      this.eventStreamListeners[name]?.push(cb);\n    } else {\n      this.eventStreamListeners[name] = [cb];\n    }\n  };\n\n  private removeEventStreamListener = (name: EventMetadata['eventName'], callback: () => void) => {\n    if (this.eventStreamListeners[name]) {\n      const filteredListeners = this.eventStreamListeners[name]?.filter((cb) => cb !== callback);\n      this.eventStreamListeners[name] = filteredListeners;\n    }\n  };\n\n  private onMessage = (...args: Parameters<typeof onBroadcastedPostMessage>) => {\n    const unsubFxn = onBroadcastedPostMessage(args[0], { allowedOrigin: this.host, ...args[1] });\n    this.unsubs.push(unsubFxn);\n\n    return unsubFxn;\n  };\n\n  private log = (...args: Parameters<typeof console.log>) => {\n    if (this.debug) {\n      console.log('[CBPAY]', ...args);\n    }\n  };\n}\n\nfunction openWindow(url: string, experience: Experience) {\n  return window.open(\n    url,\n    'Coinbase',\n    experience === 'popup'\n      ? `toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, height=${PopupSizes.signin.height},width=${PopupSizes.signin.width}`\n      : undefined,\n  );\n}\n","import { JsonObject } from 'types/JsonTypes';\nimport { CBPayExperienceOptions, Experience, WidgetType } from 'types/widget';\nimport { CoinbasePixel } from './CoinbasePixel';\n\nexport type InternalExperienceOptions = Omit<\n  CBPayExperienceOptions<JsonObject>,\n  'widgetParameters'\n> & {\n  widget: WidgetType;\n  experienceLoggedIn: Experience; // Required\n};\n\nexport type CBPayInstanceConstructorArguments = {\n  appParams: JsonObject;\n} & InternalExperienceOptions;\n\nconst widgetRoutes: Record<WidgetType, string> = {\n  buy: '/buy',\n  checkout: '/checkout',\n  sell: '/v3/sell',\n};\n\nexport interface CBPayInstanceType {\n  open: () => void;\n  destroy: () => void;\n}\n\nexport class CBPayInstance implements CBPayInstanceType {\n  private pixel: CoinbasePixel;\n  private options: InternalExperienceOptions;\n\n  constructor(options: CBPayInstanceConstructorArguments) {\n    this.options = options;\n    this.pixel = new CoinbasePixel({\n      ...options,\n      appParams: {\n        widget: options.widget,\n        ...options.appParams,\n      },\n    });\n\n    if (options.target) {\n      const targetElement = document.querySelector(options.target);\n      if (targetElement) {\n        targetElement.addEventListener('click', this.open);\n      }\n    }\n  }\n\n  public open = (): void => {\n    const {\n      widget,\n      experienceLoggedIn,\n      experienceLoggedOut,\n      embeddedContentStyles,\n      onExit,\n      onSuccess,\n      onEvent,\n      onRequestedUrl,\n      closeOnSuccess,\n      closeOnExit,\n    } = this.options;\n\n    this.pixel.openExperience({\n      path: widgetRoutes[widget],\n      experienceLoggedIn,\n      experienceLoggedOut,\n      embeddedContentStyles,\n      onExit: () => {\n        onExit?.();\n        if (closeOnExit) {\n          this.pixel.endExperience();\n        }\n      },\n      onSuccess: () => {\n        onSuccess?.();\n        if (closeOnSuccess) {\n          this.pixel.endExperience();\n        }\n      },\n      onRequestedUrl,\n      onEvent,\n    });\n  };\n\n  public destroy = (): void => {\n    this.pixel.destroy();\n  };\n}\n","import { CBPayExperienceOptions } from '../types/widget';\nimport { CBPayInstance, CBPayInstanceType } from '../utils/CBPayInstance';\nimport { OnRampAppParams } from '../types/onramp';\n\nexport type InitOnRampParams = CBPayExperienceOptions<OnRampAppParams>;\n\nexport type InitOnRampCallback = {\n  (error: Error, instance: null): void;\n  (error: null, instance: CBPayInstanceType): void;\n};\n\nexport const initOnRamp = (\n  {\n    experienceLoggedIn = 'new_tab', // default experience type\n    widgetParameters,\n    ...options\n  }: InitOnRampParams,\n  callback: InitOnRampCallback,\n): void => {\n  const instance = new CBPayInstance({\n    ...options,\n    widget: 'buy',\n    experienceLoggedIn,\n    appParams: widgetParameters,\n  });\n  callback(null, instance);\n};\n","import { EventMetadata } from 'types/events';\nimport { broadcastPostMessage, SdkTarget } from './postMessage';\n\nexport function broadcastEvent(sdkTarget: SdkTarget, event: EventMetadata): void {\n  broadcastPostMessage(sdkTarget, 'event', {\n    data: event,\n  });\n}\n"]}